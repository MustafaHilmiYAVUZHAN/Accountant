import sqlite3
from datetime import datetime


class ProductRecords:
    def __init__(self, db_name="Data\\productrecords.sql"):
        self.conn = sqlite3.connect(db_name)
        self.cursor = self.conn.cursor()
        self.create_table()

    def create_table(self):
        self.cursor.execute('''CREATE TABLE IF NOT EXISTS products (
            product_name TEXT,
            barcode TEXT,
            amount REAL,
            selling_price REAL,
            piece INTEGER,
            unit TEXT,
            time TEXT,
            date TEXT,
            user TEXT,
            process_type TEXT,
            customer TEXT,
            payment_status TEXT,
            description TEXT
        )''')
        self.conn.commit()

    def refresh_for_time(self):
        # Create a temporary table to store sorted data
        self.cursor.execute('''
            CREATE TEMPORARY TABLE sorted_products AS
            SELECT * FROM products
            ORDER BY datetime(substr(date, 7, 4) || '-' || substr(date, 4, 2) || '-' || substr(date, 1, 2) || ' ' || time) DESC
        ''')

        # Clear the original table
        self.cursor.execute('DELETE FROM products')

        # Insert sorted data back into the original table
        self.cursor.execute('''
            INSERT INTO products
            SELECT * FROM sorted_products
        ''')

        # Commit the changes and drop the temporary table
        self.conn.commit()
        self.cursor.execute('DROP TABLE sorted_products')

    def add(self, product_name, barcode, amount, selling_price, piece, unit, user, process_type, customer, payment_status, description=None, time=None, date=None):
        now = datetime.now()
        if time is None:
            time = now.strftime("%H:%M:%S")
        if date is None:
            date = now.strftime("%d/%m/%Y")
        self.cursor.execute('''INSERT INTO products (
            product_name, barcode, amount, selling_price, piece, unit, time, date, user, process_type, customer, payment_status, description
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)''', 
        (product_name, barcode, float(amount), float(selling_price), int(piece), unit, time, date, user, process_type, customer, payment_status, description))
        self.conn.commit()

    def get_by_row_id(self, row_id):
        self.cursor.execute('SELECT * FROM products WHERE ROWID=?', (row_id,))
        return self.cursor.fetchone()

    def find_row_id(self, product_name, barcode, amount, selling_price, piece, unit, time, date, user, process_type, customer, payment_status, description):
        self.cursor.execute('''SELECT ROWID FROM products WHERE
            product_name=? AND barcode=? AND amount=? AND selling_price=? AND piece=? AND unit=? AND time=? AND date=? AND user=? AND process_type=? AND customer=? AND payment_status=? AND description=?''',
            (product_name, barcode, amount, selling_price, piece, unit, time, date, user, process_type, customer, payment_status, description))
        result = self.cursor.fetchone()
        return result[0] if result else None

    def get_stock(self, identifier):
        self.cursor.execute('''SELECT SUM(piece) FROM products WHERE product_name=? OR barcode=?''', (identifier, identifier))
        result = self.cursor.fetchone()
        return result[0] if result else 0
    def get_customer(self, customer):
        self.cursor.execute('''SELECT * FROM products WHERE customer=?''', (customer,))
        return self.cursor.fetchall()

    def get_product(self, product):
        self.cursor.execute('''SELECT * FROM products WHERE product_name=?''', (product,))
        return self.cursor.fetchall()

    def get_barcode(self, barcode):
        self.cursor.execute('''SELECT * FROM products WHERE barcode=?''', (barcode,))
        return self.cursor.fetchall()

    def get_first_data(self, identifier):
        self.cursor.execute('''SELECT * FROM products WHERE product_name=? OR barcode=? ORDER BY ROWID ASC LIMIT 1''', (identifier, identifier))
        result = self.cursor.fetchone()
        if result:
            return {
                "product_name": result[0],
                "barcode": result[1],
                "amount": result[2],
                "selling_price": result[3],
                "piece": result[4],
                "unit": result[5],
                "time": result[6],
                "date": result[7],
                "user": result[8],
                "process_type": result[9],
                "customer": result[10],
                "payment_status": result[11],
                "description": result[12]
            }
        return None

    def get_last_data(self, identifier):
        self.cursor.execute('''SELECT * FROM products WHERE product_name=? OR barcode=? ORDER BY ROWID DESC LIMIT 1''', (identifier, identifier))
        result = self.cursor.fetchone()
        if result:
            return {
                "product_name": result[0],
                "barcode": result[1],
                "amount": result[2],
                "selling_price": result[3],
                "piece": result[4],
                "unit": result[5],
                "time": result[6],
                "date": result[7],
                "user": result[8],
                "process_type": result[9],
                "customer": result[10],
                "payment_status": result[11],
                "description": result[12]
            }
        return None

    def get_table(self):
        self.cursor.execute('SELECT * FROM products')
        return self.cursor.fetchall()
    

    def delete_row(self, row_id):
        self.cursor.execute('DELETE FROM products WHERE ROWID=?', (row_id,))
        self.conn.commit()

    def find(self, column, value):
        query = f'SELECT * FROM products WHERE {column}=?'
        self.cursor.execute(query, (value,))
        return self.cursor.fetchall()

    def get_unique_product_names(self):
        self.cursor.execute('SELECT DISTINCT product_name FROM products')
        return [row[0] for row in self.cursor.fetchall()]
    def get_unique_product_units(self):
        self.cursor.execute('SELECT DISTINCT unit FROM products')
        return [row[0] for row in self.cursor.fetchall()]
    def get_unique_payment_status(self):
        self.cursor.execute('SELECT DISTINCT payment_status FROM products')
        return [row[0] for row in self.cursor.fetchall()]
    def get_unique_customers(self):
        self.cursor.execute('SELECT DISTINCT customer FROM products')
        return [row[0] for row in self.cursor.fetchall()]
    def get_numerate_table(self):
        list_=self.get_table()
        return [(i + 1,) + list_[i] for i in range(len(list_))]
    def get_numerate(self,list_):
        return [(i + 1,) + list_[i] for i in range(len(list_))]
    def filter_by_date(self, start_date, end_date):
        start_date_str = f"{start_date['Day']:02d}/{start_date['Month']:02d}/{start_date['Year']}"
        end_date_str = f"{end_date['Day']:02d}/{end_date['Month']:02d}/{end_date['Year']}"
        self.cursor.execute('''
            SELECT * FROM products WHERE date BETWEEN ? AND ?
        ''', (start_date_str, end_date_str))
        return self.cursor.fetchall()
    def get_unique_customers_by_process_type(self, process_type):
        self.cursor.execute('''
            SELECT DISTINCT customer
            FROM products
            WHERE process_type = ?
        ''', (process_type,))
        customers = self.cursor.fetchall()
         
        return [customer[0] for customer in customers] if [customer[0] for customer in customers]  else [""]

    def get_by_date(self, date_dict):
        day = int(date_dict.get('Day'))
        month = int(date_dict.get('Month'))
        year = int(date_dict.get('Year'))
        
        date_str = f"{day:02d}/{month:02d}/{year}"
        
        self.cursor.execute('''SELECT * FROM products WHERE date=?''', (date_str,))
        return self.cursor.fetchall()
class PasswordManager:
    def __init__(self):
        self.file_name = "Data\\AccessData.sql"
        self.connect()
        self.create_table()
        if self.find_data("main") is None:
            self.insert_data("main","main")
            print(self.find_data("main"))

    def connect(self):
        self.connection = sqlite3.connect(self.file_name)
        self.cursor = self.connection.cursor()

    def create_table(self):
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS Data(
                name TEXT PRIMARY KEY,
                password TEXT
            )
        ''')
        self.connection.commit()

    def list_name(self):
        self.cursor.execute("SELECT name FROM Data")
        return self.cursor.fetchall()

    def insert_data(self, name, password):
        self.cursor.execute('''
            INSERT INTO Data (name, password)
            VALUES (?, ?)
        ''', (name, password))
        self.connection.commit()
        print(f"Inserted data with name: {name}")

    def delete_data(self, name):
        self.cursor.execute('''
            DELETE FROM Data WHERE name=?
        ''', (name,))
        self.connection.commit()

    def find_data(self, name):
        try:
            self.cursor.execute('''
                SELECT * FROM Data WHERE name=?
            ''', (name,))
            return self.cursor.fetchone()
        except:
            return None

    def close_connection(self):
        self.connection.close()



# Usage example
if __name__ == "__main__":
    db = ProductRecords()

    # Adding 25 complex records
    records = ["ProductA", "0000000001", 100.0, 0, 10, "unitA", "user1", "buy", "customer1", "paid"]
    db.add(*records)